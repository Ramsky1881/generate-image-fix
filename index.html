<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Gambar & Obrolan AI Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-900 */
        }
        body.dark {
            background-color: #111827; /* bg-gray-900 */
            color: #f9fafb; /* text-gray-100 */
        }
        .dark .bg-white {
            background-color: #1f2937; /* bg-gray-800 */
        }
        .dark .bg-gray-50 {
            background-color: #374151; /* bg-gray-700 */
        }
        .dark .bg-gray-200 {
            background-color: #4b5563; /* bg-gray-600 */
        }
        .dark .border-gray-300 {
            border-color: #4b5563; /* border-gray-600 */
        }
        .dark .text-gray-700 {
            color: #d1d5db; /* text-gray-300 */
        }
        .dark .text-gray-800 {
            color: #e5e7eb; /* text-gray-200 */
        }
        .dark .text-gray-600 {
            color: #9ca3af; /* text-gray-400 */
        }
        .dark .text-indigo-700 {
            color: #818cf8; /* text-indigo-400 */
        }
        .dark .text-indigo-600 {
            color: #a78bfa; /* text-indigo-300 */
        }
        .dark .text-indigo-900 {
            color: #e0e7ff; /* text-indigo-100 */
        }
        .dark .text-indigo-200 {
            color: #c7d2fe; /* text-indigo-200 */
        }
        .dark .bg-indigo-700 {
            background-color: #4f46e5; /* indigo-600 */
        }
        .dark .bg-indigo-900 {
            background-color: #3730a3; /* indigo-900 */
        }
        .dark .bg-indigo-50 {
            background-color: #312e81; /* indigo-900 with some transparency */
        }
        .dark .border-indigo-200 {
            border-color: #4338ca; /* indigo-700 */
        }
        .dark .bg-purple-600 {
            background-color: #8b5cf6; /* purple-500 */
        }
        .dark .hover\:bg-purple-700:hover {
            background-color: #7c3aed; /* purple-600 */
        }
        .dark .hover\:bg-gray-300:hover {
          background-color: #4b5563; /* gray-600 */
        }
        .dark .hover\:bg-gray-400:hover {
            background-color: #6b7280; /* gray-500 */
        }
        .dark .hover\:bg-gray-600:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .dark .hover\:bg-gray-500:hover {
            background-color: #6b7280; /* gray-500 */
        }

        /* Chatbox specific styles */
        #chat-box.hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }
        #chat-box {
            transform: translateX(0);
            opacity: 1;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .chat-messages {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 16rem; /* h-64 */
        }
        .chat-messages .message-user {
            align-self: flex-end;
        }
        .chat-messages .message-ai {
            align-self: flex-start;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center font-inter">

    <div class="w-full max-w-4xl p-6 bg-white rounded-xl shadow-lg my-4">
        <h1 id="app-name" class="text-4xl font-bold text-center mb-6 text-indigo-700"></h1>

        <div class="flex justify-end mb-4">
            <button id="language-toggle" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors duration-200"></button>
        </div>

        <p id="auth-error" class="text-red-500 text-center mb-4"></p>

        <!-- Login Form -->
        <div id="login-view">
            <form id="auth-form" class="p-6 bg-gray-50 rounded-xl shadow-inner">
                <div class="mb-4">
                    <label id="name-label" class="block text-gray-700 text-sm font-bold mb-2" for="name"></label>
                    <input
                        type="text"
                        id="name-input"
                        class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        required
                    />
                </div>
                <div class="mb-6">
                    <label id="password-label" class="block text-gray-700 text-sm font-bold mb-2" for="password"></label>
                    <input
                        type="password"
                        id="password-input"
                        class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        required
                    />
                </div>
                <div class="flex items-center justify-between mb-4">
                    <button
                        type="submit"
                        id="auth-submit-btn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md flex-grow mr-2"
                    ></button>
                    <button
                        type="button"
                        id="auth-toggle-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md flex-grow ml-2"
                    ></button>
                </div>
            </form>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="user-id-display" class="text-sm text-gray-600"></span>
                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 shadow-md"></button>
            </div>

            <!-- Image Generator Section -->
            <div class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 id="generate-image-title" class="text-3xl font-semibold mb-4 text-indigo-600"></h2>
                <p id="image-generator-info" class="text-sm text-gray-600 mb-4"></p>

                <div class="mb-4">
                    <label id="style-select-label" class="block text-gray-700 text-sm font-bold mb-2" for="style-select"></label>
                    <select
                        id="style-select"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <textarea
                    id="image-prompt-textarea"
                    class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    rows="4"
                ></textarea>

                <p id="refining-prompt-status" class="text-indigo-500 text-center mb-4 flex items-center justify-center hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="refining-prompt-text"></span>
                </p>

                <div id="refined-prompt-display" class="mb-4 p-3 bg-indigo-50 rounded-lg hidden">
                    <p id="refined-prompt-label" class="text-sm font-semibold text-indigo-800"></p>
                    <p id="refined-prompt-text-content" class="text-gray-700"></p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button
                        id="generate-image-btn"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md text-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                        <span id="generate-image-btn-text"></span>
                    </button>
                    <button
                        id="save-prompt-btn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md text-lg"
                    ></button>
                </div>

                <p id="image-error" class="text-red-500 text-center mb-4"></p>

                <div id="generated-image-container" class="mt-6 text-center hidden">
                    <h3 id="image-description-title" class="text-xl font-medium mb-3"></h3>
                    <img id="generated-image" src="" alt="" class="max-w-full h-auto rounded-lg shadow-md mx-auto border-4 border-indigo-300" />
                    <button
                        id="generate-caption-btn"
                        class="mt-4 px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md text-base flex items-center justify-center mx-auto"
                    >
                        <span id="generate-caption-btn-text"></span>
                    </button>
                    <p id="caption-error" class="text-red-500 mt-2"></p>
                    <div id="generated-caption-display" class="mt-4 p-3 bg-gray-100 rounded-lg hidden">
                        <p id="image-caption-label" class="text-sm font-semibold text-gray-800"></p>
                        <p id="image-caption-text-content" class="text-gray-700"></p>
                    </div>
                </div>

                <div id="no-image-placeholder" class="mt-6 text-center">
                    <p id="no-image-text"></p>
                    <img
                        src="https://placehold.co/400x300/a3a3a3/ffffff?text=Image+Placeholder"
                        alt="Image Placeholder"
                        class="max-w-full h-auto rounded-lg shadow-md mx-auto mt-4"
                    />
                </div>

                <!-- Prompt Help Section -->
                <div class="mt-8 p-4 bg-gray-50 rounded-xl shadow-inner">
                    <h3 id="prompt-help-title" class="text-xl font-semibold mb-3 text-indigo-600"></h3>
                    <p id="prompt-suggestions-text" class="mb-3 text-gray-700"></p>
                    <div class="flex mb-3">
                        <input
                            type="text"
                            id="suggestion-keyword-input"
                            class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder=""
                        />
                        <button
                            id="get-suggestions-btn"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-r-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                            <span id="get-suggestions-btn-text"></span>
                        </button>
                    </div>
                    <div id="dynamic-prompt-suggestions-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Dynamic suggestions populated by JS -->
                    </div>
                </div>

                <!-- Saved Prompts Section -->
                <div class="mt-8 p-4 bg-gray-50 rounded-xl shadow-inner">
                    <h3 id="saved-prompts-title" class="text-xl font-semibold mb-3 text-indigo-600"></h3>
                    <ul id="saved-prompts-list" class="space-y-2">
                        <!-- Saved prompts populated by JS -->
                        <p id="no-saved-prompts-text" class="text-gray-500"></p>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Chatbox -->
    <div id="chat-box" class="fixed bottom-4 right-4 w-full max-w-sm bg-white rounded-xl shadow-lg transition-transform duration-300 ease-in-out z-40 md:w-80 hidden">
        <div class="p-6">
            <h2 id="chat-with-ai-title" class="text-2xl font-semibold mb-4 text-indigo-600"></h2>
            <div id="chat-messages-container" class="chat-messages border border-gray-300 rounded-lg p-4 mb-4 bg-gray-50">
                <p id="chat-placeholder-text" class="text-center text-gray-500"></p>
                <div id="chat-end-ref"></div>
            </div>
            <p id="chat-error" class="text-red-500 text-center mb-4"></p>
            <div class="flex">
                <input
                    type="text"
                    id="chat-message-input"
                    class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder=""
                />
                <button
                    id="send-message-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-r-lg focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                ></button>
            </div>
        </div>
    </div>

    <!-- Toggle Chat Button -->
    <button
        id="toggle-chat-btn"
        class="fixed bottom-4 right-4 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full shadow-lg z-50 flex items-center justify-center transition-all duration-300 transform hover:scale-105"
        aria-label="Toggle Chat"
    >
        <svg id="toggle-chat-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.11C6.236 15.112 9.42 13 13 13h.01c4.418 0 8 3.582 8 8z" />
        </svg>
    </button>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="confirm-message" class="mb-4 text-gray-800"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-md">Yes</button>
                <button id="confirm-no-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200 shadow-md">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports (Global scope for easier access)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization (Global instances)
        let app;
        let auth;
        let db;
        let firebaseInitialized = false; // New flag for Firebase initialization status

        // Ensure __app_id, __firebase_config, __initial_auth_token are defined in the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            firebaseInitialized = true; // Set flag to true if initialization is successful
        } catch (error) {
            console.error("Error initializing Firebase:", error);
        }

        // Translations object (same as before)
        const translations = {
            en: {
                appName: "Gemini AI Image Generator & Chat",
                login: "Login",
                register: "Register",
                logout: "Logout",
                name: "Name",
                password: "Password",
                loginSuccess: "Logged in successfully!",
                registerSuccess: "Registered successfully! You are now logged in.",
                loginError: "Login failed: ",
                registerError: "Registration failed: ",
                generateImage: "Generate AI Image",
                imagePromptPlaceholder: "Describe the image you want to generate...",
                generatingImage: "Generating image...",
                imageGenerationSuccess: "Image generated successfully!",
                imageGenerationError: "Image generation failed: ",
                promptHelp: "Prompt Help",
                promptSuggestions: "Need ideas? Try these:",
                chatWithAI: "Chat with AI",
                chatPlaceholder: "Type your message here...",
                sendMessage: "Send",
                aiThinking: "AI is thinking...",
                chatError: "Chat error: ",
                userId: "User ID:",
                switchLanguage: "Switch to Indonesian",
                welcome: "Welcome!",
                loginToContinue: "Please login to continue.",
                anonymousLogin: "Sign In Anonymously",
                nameRequired: "Name is required.",
                passwordRequired: "Password is required.",
                imageDescription: "Generated AI Image",
                noImageYet: "No image generated yet. Enter a prompt and click 'Generate AI Image'.",
                savePrompt: "Save Prompt",
                savedPrompts: "Saved Prompts",
                noSavedPrompts: "No saved prompts.",
                delete: "Delete",
                confirmDeletePrompt: "Are you sure you want to delete this prompt?",
                usePrompt: "Use",
                selectStyle: "Select Style:",
                styleRealistic: "Realistic",
                styleCartoon: "Cartoon",
                styleAbstract: "Abstract",
                styleCinematic: "Cinematic",
                styleWatercolor: "Watercolor",
                refiningPrompt: "Refining prompt...",
                refinedPrompt: "Refined Prompt (English):",
                toggleChat: "Toggle Chat",
                generateCaption: "Generate Caption ✨",
                generatingCaption: "Generating caption...",
                captionUnavailable: "Caption generation is only available for images generated by Gemini, due to multimodal limitations.",
                captionError: "Caption generation failed: ",
                imageCaption: "Image Caption:",
                keywordPrompt: "Enter keyword for suggestions:",
                getSuggestions: "Get Suggestions ✨",
                suggestingPrompts: "Getting prompt suggestions...",
                invalidCredentials: "Invalid name or password.",
                imageGeneratorInfo: "Image generation is currently powered by DeepAI (Free Tier)."
            },
            id: {
                appName: "Generator Gambar & Obrolan AI Gemini",
                login: "Masuk",
                register: "Daftar",
                logout: "Keluar",
                name: "Nama",
                password: "Kata Sandi",
                loginSuccess: "Berhasil masuk!",
                registerSuccess: "Berhasil mendaftar! Anda sekarang masuk.",
                loginError: "Gagal masuk: ",
                registerError: "Gagal mendaftar: ",
                generateImage: "Buat Gambar AI",
                imagePromptPlaceholder: "Jelaskan gambar yang ingin Anda buat...",
                generatingImage: "Sedang membuat gambar...",
                imageGenerationSuccess: "Gambar berhasil dibuat!",
                imageGenerationError: "Gagal membuat gambar: ",
                promptHelp: "Bantuan Prompt",
                promptSuggestions: "Butuh ide? Coba ini:",
                chatWithAI: "Mengobrol dengan AI",
                chatPlaceholder: "Ketik pesan Anda di sini...",
                sendMessage: "Kirim",
                aiThinking: "AI sedang berpikir...",
                chatError: "Kesalahan obrolan: ",
                userId: "ID Pengguna:",
                switchLanguage: "Beralih ke Bahasa Inggris",
                welcome: "Selamat datang!",
                loginToContinue: "Silakan masuk untuk melanjutkan.",
                anonymousLogin: "Masuk Anonim",
                nameRequired: "Nama diperlukan.",
                passwordRequired: "Kata Sandi diperlukan.",
                imageDescription: "Gambar AI yang Dihasilkan",
                noImageYet: "Belum ada gambar yang dibuat. Masukkan prompt dan klik 'Buat Gambar AI'.",
                savePrompt: "Simpan Prompt",
                savedPrompts: "Prompt Tersimpan",
                noSavedPrompts: "Tidak ada prompt yang disimpan.",
                delete: "Hapus",
                confirmDeletePrompt: "Apakah Anda yakin ingin menghapus prompt ini?",
                usePrompt: "Gunakan",
                selectStyle: "Pilih Gaya:",
                styleRealistic: "Realistis",
                styleCartoon: "Kartun",
                styleAbstract: "Abstrak",
                styleCinematic: "Sinematik",
                styleWatercolor: "Cat Air",
                refiningPrompt: "Memperbaiki prompt...",
                refinedPrompt: "Prompt yang Diperbaiki (English):",
                toggleChat: "Alihkan Obrolan",
                generateCaption: "Buat Keterangan Gambar ✨",
                generatingCaption: "Sedang membuat keterangan gambar...",
                captionUnavailable: "Pembuatan keterangan gambar hanya tersedia untuk gambar yang dihasilkan oleh Gemini, karena keterbatasan multimodal.",
                captionError: "Gagal membuat keterangan gambar: ",
                imageCaption: "Keterangan Gambar:",
                keywordPrompt: "Masukkan kata kunci untuk saran:",
                getSuggestions: "Dapatkan Saran ✨",
                suggestingPrompts: "Sedang mendapatkan saran prompt...",
                invalidCredentials: "Nama atau kata sandi tidak valid.",
                imageGeneratorInfo: "Pembuatan gambar saat ini didukung oleh DeepAI (Paket Gratis)."
            }
        };

        let currentUser = null;
        let currentLanguage = 'id'; // Default language
        let dynamicPromptSuggestions = []; // Make dynamicPromptSuggestions a global variable

        // Hardcoded credentials for local validation
        const ADMIN_NAME = "admin";
        const ADMIN_PASSWORD = "buntutgrup";

        // API Keys
        const GEMINI_API_KEY = "AIzaSyCeC4RzS5_GETZO0Ql8tJehZtV-rREnrpI";
        const DEEPAI_API_KEY = "eb2dbb43-7358-4ca8-a045-e43d7b1011e0"; // Updated DeepAI API Key
        const DEEPAI_API_URL = "https://api.deepai.org/api/text2img";

        // DOM Elements
        const appNameEl = document.getElementById('app-name');
        const languageToggleBtn = document.getElementById('language-toggle');
        const authErrorEl = document.getElementById('auth-error');
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');

        const authForm = document.getElementById('auth-form');
        const nameInput = document.getElementById('name-input');
        const passwordInput = document.getElementById('password-input');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const nameLabel = document.getElementById('name-label');
        const passwordLabel = document.getElementById('password-label');

        const userIdDisplay = document.getElementById('user-id-display');
        const logoutBtn = document.getElementById('logout-btn');

        const generateImageTitle = document.getElementById('generate-image-title');
        const imageGeneratorInfo = document.getElementById('image-generator-info');
        const styleSelectLabel = document.getElementById('style-select-label');
        const styleSelect = document.getElementById('style-select');
        const imagePromptTextarea = document.getElementById('image-prompt-textarea');
        const refiningPromptStatus = document.getElementById('refining-prompt-status');
        const refiningPromptText = document.getElementById('refining-prompt-text');
        const refinedPromptDisplay = document.getElementById('refined-prompt-display');
        const refinedPromptLabel = document.getElementById('refined-prompt-label');
        const refinedPromptTextContent = document.getElementById('refined-prompt-text-content');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const generateImageBtnText = document.getElementById('generate-image-btn-text');
        const savePromptBtn = document.getElementById('save-prompt-btn');
        const imageErrorEl = document.getElementById('image-error');
        const generatedImageContainer = document.getElementById('generated-image-container');
        const imageDescriptionTitle = document.getElementById('image-description-title');
        const generatedImage = document.getElementById('generated-image');
        const generateCaptionBtn = document.getElementById('generate-caption-btn');
        const generateCaptionBtnText = document.getElementById('generate-caption-btn-text');
        const captionErrorEl = document.getElementById('caption-error');
        const generatedCaptionDisplay = document.getElementById('generated-caption-display');
        const imageCaptionLabel = document.getElementById('image-caption-label');
        const imageCaptionTextContent = document.getElementById('image-caption-text-content');
        const noImagePlaceholder = document.getElementById('no-image-placeholder');
        const noImageText = document.getElementById('no-image-text');

        const promptHelpTitle = document.getElementById('prompt-help-title');
        const promptSuggestionsText = document.getElementById('prompt-suggestions-text');
        const suggestionKeywordInput = document.getElementById('suggestion-keyword-input');
        const getSuggestionsBtn = document.getElementById('get-suggestions-btn');
        const getSuggestionsBtnText = document.getElementById('get-suggestions-btn-text');
        const dynamicPromptSuggestionsContainer = document.getElementById('dynamic-prompt-suggestions-container');

        const savedPromptsTitle = document.getElementById('saved-prompts-title');
        const savedPromptsList = document.getElementById('saved-prompts-list');
        const noSavedPromptsText = document.getElementById('no-saved-prompts-text');

        const chatBox = document.getElementById('chat-box');
        const chatWithAiTitle = document.getElementById('chat-with-ai-title');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatPlaceholderText = document.getElementById('chat-placeholder-text');
        const chatEndRef = document.getElementById('chat-end-ref');
        const chatErrorEl = document.getElementById('chat-error');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const toggleChatIcon = document.getElementById('toggle-chat-icon');

        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // Initial language and UI setup
        let isRegistering = false;
        let isChatBoxOpen = false;
        let chatHistory = [];
        let promptToDelete = null;
        let generatedImageUrl = '';

        const styles = [
            { value: 'Realistic', label: 'styleRealistic' },
            { value: 'Cartoon', label: 'styleCartoon' },
            { value: 'Abstract', label: 'styleAbstract' },
            { value: 'Cinematic', label: 'styleCinematic' },
            { value: 'Watercolor', label: 'styleWatercolor' },
        ];

        const staticPromptSuggestionsList = [
            "A futuristic city at sunset, with flying cars and neon lights, highly detailed, cinematic.",
            "A serene forest with a hidden waterfall, mystic atmosphere, vibrant colors, realistic.",
            "An astronaut floating in space, looking at a distant galaxy, artistic, sci-fi.",
            "A cute fluffy cat wearing a tiny hat, watercolor style, whimsical.",
            "A majestic dragon perched on a mountain peak, fantasy art, epic scale.",
            "Sebuah kota futuristik saat matahari terbenam, dengan mobil terbang dan lampu neon, sangat detail, sinematik.",
            "Hutan yang tenang dengan air terjun tersembunyi, suasana mistis, warna cerah, realistis.",
            "Seorang astronot melayang di angkasa, melihat galaksi yang jauh, artistik, fiksi ilmiah.",
            "Kucing lucu berbulu halus memakai topi kecil, gaya cat air, aneh dan menyenangkan.",
            "Naga megah bertengger di puncak gunung, seni fantasi, skala epik."
        ];

        // --- Functions ---

        function applyTranslations() {
            const t = translations[currentLanguage];
            appNameEl.textContent = t.appName;
            languageToggleBtn.textContent = t.switchLanguage;

            nameLabel.textContent = t.name;
            passwordLabel.textContent = t.password;
            nameInput.placeholder = t.name;
            passwordInput.placeholder = t.password;
            authSubmitBtn.textContent = isRegistering ? t.register : t.login;
            authToggleBtn.textContent = isRegistering ? t.login : t.register;

            generateImageTitle.textContent = t.generateImage;
            imageGeneratorInfo.textContent = t.imageGeneratorInfo;
            styleSelectLabel.textContent = t.selectStyle;
            imagePromptTextarea.placeholder = t.imagePromptPlaceholder;
            refiningPromptText.textContent = t.refiningPrompt;
            refinedPromptLabel.textContent = t.refinedPrompt;
            generateImageBtnText.textContent = t.generateImage;
            savePromptBtn.textContent = t.savePrompt;
            imageDescriptionTitle.textContent = t.imageDescription;
            generateCaptionBtnText.textContent = t.generateCaption;
            imageCaptionLabel.textContent = t.imageCaption;
            noImageText.textContent = t.noImageYet;
            promptHelpTitle.textContent = t.promptHelp;
            promptSuggestionsText.textContent = t.promptSuggestions;
            suggestionKeywordInput.placeholder = t.keywordPrompt;
            getSuggestionsBtnText.textContent = t.getSuggestions;
            savedPromptsTitle.textContent = t.savedPrompts;
            noSavedPromptsText.textContent = t.noSavedPrompts;
            chatWithAiTitle.textContent = t.chatWithAI;
            chatPlaceholderText.textContent = t.chatPlaceholder;
            chatMessageInput.placeholder = t.chatPlaceholder;
            sendMessageBtn.textContent = t.sendMessage;
            logoutBtn.textContent = t.logout;

            // Update style options
            styleSelect.innerHTML = '';
            styles.forEach(style => {
                const option = document.createElement('option');
                option.value = style.value;
                option.textContent = t[style.label];
                styleSelect.appendChild(option);
            });
            // Re-select the correct style after updating options
            styleSelect.value = styleSelect.dataset.currentValue || 'Realistic'; // Use a data attribute to store current value

            // Pass the global dynamicPromptSuggestions to the update function
            updateDynamicPromptSuggestions(dynamicPromptSuggestions.length > 0 ? dynamicPromptSuggestions : staticPromptSuggestionsList);
        }

        function setAuthError(message) {
            authErrorEl.textContent = message;
            authErrorEl.classList.remove('hidden');
        }

        function hideAuthError() {
            authErrorEl.textContent = '';
            authErrorEl.classList.add('hidden');
        }

        function setImageError(message) {
            imageErrorEl.textContent = message;
            imageErrorEl.classList.remove('hidden');
        }

        function hideImageError() {
            imageErrorEl.textContent = '';
            imageErrorEl.classList.add('hidden');
        }

        function setCaptionError(message) {
            captionErrorEl.textContent = message;
            captionErrorEl.classList.remove('hidden');
        }

        function hideCaptionError() {
            captionErrorEl.textContent = '';
            captionErrorEl.classList.add('hidden');
        }

        async function handleLogin(name, password) {
            hideAuthError();
            try {
                const t = translations[currentLanguage];
                if (!name) throw new Error(t.nameRequired);
                if (!password) throw new Error(t.passwordRequired);

                if (name === ADMIN_NAME && password === ADMIN_PASSWORD) {
                    // Check if Firebase auth and db objects are available and initialized
                    if (!firebaseInitialized) {
                        setAuthError("Layanan Firebase tidak diinisialisasi sepenuhnya. Mohon tunggu sebentar dan coba lagi.");
                        return;
                    }
                    
                    let firebaseUser = auth.currentUser;
                    if (!firebaseUser) { // If no user is signed in (including anonymously), sign in anonymously
                        firebaseUser = await signInAnonymously(auth);
                    }
                    
                    currentUser = { uid: firebaseUser.uid, displayName: ADMIN_NAME, isAnonymous: false };
                    userIdDisplay.textContent = `${t.userId} ${currentUser.uid}`;
                    loginView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                    console.log(t.loginSuccess);
                    fetchSavedPrompts();
                } else {
                    setAuthError(t.invalidCredentials);
                }
            } catch (error) {
                setAuthError(translations[currentLanguage].loginError + error.message);
                console.error(translations[currentLanguage].loginError, error);
            }
        }

        function handleRegister(name, password) {
            handleLogin(name, password);
        }

        async function handleLogout() {
            hideAuthError();
            try {
                currentUser = null;
                userIdDisplay.textContent = '';
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                if (auth && auth.currentUser) {
                    await signOut(auth);
                }
                console.log(translations[currentLanguage].logout);
                savedPromptsList.innerHTML = `<p id="no-saved-prompts-text" class="text-gray-500">${translations[currentLanguage].noSavedPrompts}</p>`;
            } catch (error) {
                setAuthError(`Logout failed: ${error.message}`);
                console.error("Logout failed:", error);
            }
        }

        async function refinePromptWithAI(promptToRefine, style) {
            refiningPromptStatus.classList.remove('hidden');
            hideImageError();
            try {
                const chatHistoryPayload = [{
                    role: "user",
                    parts: [{ text: `Translate and refine the following Indonesian prompt into a detailed English prompt for an AI image generator, ensuring it's suitable for a '${style}' style image. Focus on descriptive visual details. Only provide the refined English prompt as output, no other text or explanation:\n\n${promptToRefine}` }]
                }];
                const payload = { contents: chatHistoryPayload };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const refined = result.candidates[0].content.parts[0].text;
                    refiningPromptStatus.classList.add('hidden');
                    return refined;
                } else {
                    refiningPromptStatus.classList.add('hidden');
                    throw new Error(result.error?.message || "Unexpected response structure from prompt refinement AI.");
                }
            } catch (error) {
                refiningPromptStatus.classList.add('hidden');
                setImageError(translations[currentLanguage].refiningPrompt + `: ${error.message}`);
                console.error("Prompt refinement failed:", error);
                return promptToRefine;
            }
        }

        async function handleGenerateImage() {
            hideImageError();
            generatedImageContainer.classList.add('hidden');
            noImagePlaceholder.classList.remove('hidden');
            generatedCaptionDisplay.classList.add('hidden');
            imageCaptionTextContent.textContent = '';
            hideCaptionError();

            generateImageBtn.disabled = true;
            generateImageBtnText.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${translations[currentLanguage].generatingImage}`;

            const prompt = imagePromptTextarea.value.trim();
            const selectedStyleValue = styleSelect.value;

            if (!prompt) {
                setImageError(translations[currentLanguage].promptHelp);
                generateImageBtn.disabled = false;
                generateImageBtnText.textContent = translations[currentLanguage].generateImage;
                return;
            }

            let finalPrompt = prompt;
            if (currentLanguage === 'id') {
                const refined = await refinePromptWithAI(prompt, selectedStyleValue);
                finalPrompt = refined;
                refinedPromptTextContent.textContent = refined;
                refinedPromptDisplay.classList.remove('hidden');
            } else {
                finalPrompt = `${prompt}, ${selectedStyleValue} style`;
                refinedPromptTextContent.textContent = finalPrompt;
                refinedPromptDisplay.classList.remove('hidden');
            }

            try {
                // DeepAI API Call
                const formData = new FormData();
                formData.append('text', finalPrompt);

                const response = await fetch(DEEPAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'api-key': DEEPAI_API_KEY
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.output_url) {
                        generatedImageUrl = result.output_url;
                        generatedImage.src = generatedImageUrl;
                        generatedImage.alt = translations[currentLanguage].imageDescription;
                        generatedImageContainer.classList.remove('hidden');
                        noImagePlaceholder.classList.add('hidden');
                        console.log(translations[currentLanguage].imageGenerationSuccess);
                    } else {
                        setImageError(`${translations[currentLanguage].imageGenerationError} DeepAI: Unexpected response format. ${JSON.stringify(result)}`);
                        console.error(translations[currentLanguage].imageGenerationError, result);
                    }
                } else {
                    const errorText = await response.text();
                    setImageError(`${translations[currentLanguage].imageGenerationError} DeepAI: ${response.status} ${response.statusText} - ${errorText}`);
                    console.error(translations[currentLanguage].imageGenerationError, response.status, response.statusText, errorText);
                }
            } catch (error) {
                setImageError(translations[currentLanguage].imageGenerationError + error.message);
                console.error(translations[currentLanguage].imageGenerationError, error);
            } finally {
                generateImageBtn.disabled = false;
                generateImageBtnText.textContent = translations[currentLanguage].generateImage;
            }
        }

        async function handleGenerateCaption() {
            hideCaptionError();
            // generatedCaption is not a global variable; it should be handled by textContent directly
            imageCaptionTextContent.textContent = ''; // Clear previous caption

            generateCaptionBtn.disabled = true;
            generateCaptionBtnText.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${translations[currentLanguage].generatingCaption}`;


            if (!generatedImageUrl) {
                setCaptionError(translations[currentLanguage].noImageYet);
                generateCaptionBtn.disabled = false;
                generateCaptionBtnText.textContent = translations[currentLanguage].generateCaption;
                return;
            }

            try {
                const imageResponse = await fetch(generatedImageUrl);
                const imageBlob = await imageResponse.blob();

                const reader = new FileReader();
                reader.readAsDataURL(imageBlob);
                reader.onloadend = async () => {
                    const base64ImageData = reader.result.split(',')[1];
                    const mimeType = imageBlob.type;

                    const chatHistoryPayload = [{
                        role: "user",
                        parts: [
                            { text: "Describe this image in a concise, creative, and evocative way." },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }];

                    const payload = { contents: chatHistoryPayload };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const caption = result.candidates[0].content.parts[0].text;
                        imageCaptionTextContent.textContent = caption;
                        generatedCaptionDisplay.classList.remove('hidden');
                    } else {
                        setCaptionError(translations[currentLanguage].captionError + (result.error?.message || "Unexpected response structure from caption AI."));
                        console.error(translations[currentLanguage].captionError, result);
                    }
                    generateCaptionBtn.disabled = false;
                    generateCaptionBtnText.textContent = translations[currentLanguage].generateCaption;
                };
                reader.onerror = () => {
                    setCaptionError("Failed to read image data for captioning.");
                    generateCaptionBtn.disabled = false;
                    generateCaptionBtnText.textContent = translations[currentLanguage].generateCaption;
                };

            } catch (error) {
                setCaptionError(translations[currentLanguage].captionError + error.message);
                console.error(translations[currentLanguage].captionError, error);
                generateCaptionBtn.disabled = false;
                generateCaptionBtnText.textContent = translations[currentLanguage].generateCaption;
            }
        }

        async function handleGetSuggestions() {
            hideImageError();
            getSuggestionsBtn.disabled = true;
            getSuggestionsBtnText.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${translations[currentLanguage].suggestingPrompts}`;

            const keyword = suggestionKeywordInput.value.trim();

            if (!keyword) {
                setImageError(translations[currentLanguage].keywordPrompt);
                getSuggestionsBtn.disabled = false;
                getSuggestionsBtnText.textContent = translations[currentLanguage].getSuggestions;
                return;
            }

            try {
                const chatHistoryPayload = [{
                    role: "user",
                    parts: [{ text: `Generate 5 creative, detailed, and distinct image prompts in English related to the keyword "${keyword}". Each prompt should be suitable for AI image generation and be concise. Provide them as a numbered list. Example: "1. A vibrant coral reef..."` }]
                }];
                const payload = { contents: chatHistoryPayload };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const rawSuggestions = result.candidates[0].content.parts[0].text;
                    const parsedSuggestions = rawSuggestions.split('\n').filter(line => line.match(/^\d+\.\s/)).map(line => line.replace(/^\d+\.\s/, ''));
                    updateDynamicPromptSuggestions(parsedSuggestions);
                } else {
                    setImageError(`Failed to get suggestions: ${result.error?.message || "Unknown error"}`);
                    console.error("Failed to get suggestions:", result);
                }
            } catch (error) {
                setImageError(`Failed to get suggestions: ${error.message}`);
                console.error("Failed to get suggestions:", error);
            } finally {
                getSuggestionsBtn.disabled = false;
                getSuggestionsBtnText.textContent = translations[currentLanguage].getSuggestions;
            }
        }

        function updateDynamicPromptSuggestions(suggestions) {
            dynamicPromptSuggestionsContainer.innerHTML = '';
            if (suggestions.length === 0) {
                dynamicPromptSuggestionsContainer.textContent = translations[currentLanguage].noSavedPrompts; // Re-use translation for no suggestions
                return;
            }
            suggestions.forEach((suggestion, index) => {
                const btn = document.createElement('button');
                btn.className = "text-left p-3 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-200 text-sm shadow-sm";
                btn.textContent = suggestion;
                btn.onclick = () => handleUsePrompt({ prompt: suggestion, style: 'Realistic' }); // Default to realistic
                dynamicPromptSuggestionsContainer.appendChild(btn);
            });
        }

        async function handleSavePrompt() {
            if (!currentUser || !db) return;

            const prompt = imagePromptTextarea.value.trim();
            const selectedStyleValue = styleSelect.value;

            if (!prompt) {
                setImageError(translations[currentLanguage].promptHelp);
                return;
            }

            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/userPrompts`, Date.now().toString());
                await setDoc(userDocRef, { prompt: prompt, style: selectedStyleValue, generator: 'Gemini', timestamp: new Date(), deleted: false });
                console.log("Prompt saved successfully!");
                imagePromptTextarea.value = '';
                refinedPromptTextContent.textContent = '';
                refinedPromptDisplay.classList.add('hidden');
                hideImageError();
                // Firestore snapshot listener will update the list automatically
            } catch (error) {
                setImageError("Error saving prompt: " + error.message);
                console.error("Error saving prompt:", error);
            }
        }

        function handleUsePrompt(promptData) {
            imagePromptTextarea.value = promptData.prompt;
            styleSelect.value = promptData.style || 'Realistic';
            styleSelect.dataset.currentValue = styleSelect.value; // Store current value for language toggle
            refinedPromptTextContent.textContent = '';
            refinedPromptDisplay.classList.add('hidden');
            generatedImageUrl = '';
            generatedImage.src = '';
            generatedImageContainer.classList.add('hidden');
            noImagePlaceholder.classList.remove('hidden');
            generatedCaptionDisplay.classList.add('hidden');
            imageCaptionTextContent.textContent = '';
            hideImageError();
            hideCaptionError();
        }

        function showConfirmDialog(message, onConfirmCallback) {
            confirmMessage.textContent = message;
            confirmDialog.classList.remove('hidden');
            confirmYesBtn.onclick = () => {
                onConfirmCallback();
                confirmDialog.classList.add('hidden');
            };
            confirmNoBtn.onclick = () => {
                confirmDialog.classList.add('hidden');
            };
        }

        function handleDeletePrompt(prompt) {
            showConfirmDialog(translations[currentLanguage].confirmDeletePrompt, async () => {
                if (!currentUser || !db) return;
                try {
                    const promptDocRef = doc(db, `artifacts/${appId}/public/data/userPrompts`, prompt.id);
                    await setDoc(promptDocRef, { deleted: true }, { merge: true });
                    console.log(`Prompt '${prompt.prompt}' marked as deleted.`);
                } catch (error) {
                    console.error("Error deleting prompt:", error);
                    // Optionally show an error message to the user
                }
            });
        }

        function fetchSavedPrompts() {
            if (!currentUser || !db) {
                savedPromptsList.innerHTML = `<p id="no-saved-prompts-text" class="text-gray-500">${translations[currentLanguage].noSavedPrompts}</p>`;
                return;
            }

            const promptsCollectionRef = collection(db, `artifacts/${appId}/public/data/userPrompts`);
            const q = query(promptsCollectionRef, where("deleted", "!=", true));

            onSnapshot(q, (snapshot) => {
                const prompts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                savedPromptsList.innerHTML = ''; // Clear existing list
                if (prompts.length > 0) {
                    prompts.forEach(p => {
                        const li = document.createElement('li');
                        li.className = "flex justify-between items-center p-3 bg-gray-200 rounded-lg";
                        li.innerHTML = `
                            <span class="text-gray-700 text-sm flex-1 mr-4">
                                ${p.prompt} ${p.style ? `(${p.style})` : ''}
                            </span>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 bg-indigo-500 text-white text-sm rounded-md hover:bg-indigo-600 transition-colors duration-200 shadow-sm use-prompt-btn" data-prompt-id="${p.id}">
                                    ${translations[currentLanguage].usePrompt}
                                </button>
                                <button class="px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors duration-200 shadow-sm delete-prompt-btn" data-prompt-id="${p.id}">
                                    ${translations[currentLanguage].delete}
                                </button>
                            </div>
                        `;
                        savedPromptsList.appendChild(li);
                    });

                    // Add event listeners to new buttons
                    savedPromptsList.querySelectorAll('.use-prompt-btn').forEach(button => {
                        button.onclick = (event) => {
                            const promptId = event.target.dataset.promptId;
                            const promptData = prompts.find(p => p.id === promptId);
                            if (promptData) handleUsePrompt(promptData);
                        };
                    });
                    savedPromptsList.querySelectorAll('.delete-prompt-btn').forEach(button => {
                        button.onclick = (event) => {
                            const promptId = event.target.dataset.promptId;
                            const promptData = prompts.find(p => p.id === promptId);
                            if (promptData) handleDeletePrompt(promptData);
                        };
                    });

                } else {
                    savedPromptsList.innerHTML = `<p id="no-saved-prompts-text" class="text-gray-500">${translations[currentLanguage].noSavedPrompts}</p>`;
                }
            }, (error) => {
                console.error("Error fetching saved prompts:", error);
                // Even if there's an error, display 'no saved prompts' message
                savedPromptsList.innerHTML = `<p id="no-saved-prompts-text" class="text-red-500">Error: ${error.message}</p>`;
            });
        }

        function appendMessageToChat(message, role) {
            const messageEl = document.createElement('div');
            messageEl.className = `mb-2 ${role === 'user' ? 'self-end text-right' : 'self-start text-left'}`;
            messageEl.innerHTML = `<span class="inline-block p-2 rounded-lg ${role === 'user' ? 'bg-indigo-200 text-indigo-900' : 'bg-gray-200 text-gray-800'}">${message}</span>`;
            chatMessagesContainer.insertBefore(messageEl, chatEndRef); // Insert before the scroll ref
            chatEndRef.scrollIntoView({ behavior: 'smooth' }); // Scroll to the bottom
        }

        async function handleSendMessage() {
            const message = chatMessageInput.value.trim();
            if (!message || !currentUser) return;

            chatErrorEl.textContent = '';
            chatMessageInput.value = '';
            chatMessageInput.disabled = true;
            sendMessageBtn.disabled = true;

            appendMessageToChat(message, 'user');
            chatHistory.push({ role: "user", parts: [{ text: message }] });

            // Display AI thinking indicator
            const thinkingEl = document.createElement('div');
            thinkingEl.id = 'ai-thinking-indicator';
            thinkingEl.className = 'text-left text-gray-500 italic self-start';
            thinkingEl.innerHTML = `<span class="inline-block p-2 rounded-lg bg-gray-200">${translations[currentLanguage].aiThinking}</span>`;
            chatMessagesContainer.insertBefore(thinkingEl, chatEndRef);
            chatEndRef.scrollIntoView({ behavior: 'smooth' });

            try {
                const formattedChatHistory = chatHistory.map(entry => ({
                    role: entry.role,
                    parts: entry.parts
                }));

                const payload = { contents: formattedChatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                    appendMessageToChat(aiResponseText, 'ai');
                } else {
                    chatErrorEl.textContent = translations[currentLanguage].chatError + (result.error?.message || "Unexpected response structure.");
                    console.error(translations[currentLanguage].chatError, result);
                }
            } catch (error) {
                chatErrorEl.textContent = translations[currentLanguage].chatError + error.message;
                console.error(translations[currentLanguage].chatError, error);
            } finally {
                // Remove AI thinking indicator
                const existingThinkingEl = document.getElementById('ai-thinking-indicator');
                if (existingThinkingEl) {
                    existingThinkingEl.remove();
                }
                chatMessageInput.disabled = false;
                sendMessageBtn.disabled = false;
                chatMessageInput.focus();
            }
        }

        function toggleChatBox() {
            isChatBoxOpen = !isChatBoxOpen;
            if (isChatBoxOpen) {
                chatBox.classList.remove('hidden');
                // Change icon to 'X'
                toggleChatIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />`;
                chatEndRef.scrollIntoView({ behavior: 'smooth' }); // Scroll on open
            } else {
                chatBox.classList.add('hidden');
                // Change icon to chat bubble
                toggleChatIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.11C6.236 15.112 9.42 13 13 13h.01c4.418 0 8 3.582 8 8z" />`;
            }
        }

        // --- Event Listeners and Initial Setup ---

        languageToggleBtn.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'en' ? 'id' : 'en';
            applyTranslations();
        });

        authToggleBtn.addEventListener('click', () => {
            isRegistering = !isRegistering;
            applyTranslations(); // Update button text
        });

        authForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = nameInput.value;
            const password = passwordInput.value;
            if (isRegistering) {
                handleRegister(name, password);
            } else {
                handleLogin(name, password);
            }
        });

        logoutBtn.addEventListener('click', handleLogout);
        generateImageBtn.addEventListener('click', handleGenerateImage);
        savePromptBtn.addEventListener('click', handleSavePrompt);
        generateCaptionBtn.addEventListener('click', handleGenerateCaption);
        getSuggestionsBtn.addEventListener('click', handleGetSuggestions);
        chatMessageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });
        sendMessageBtn.addEventListener('click', handleSendMessage);
        toggleChatBtn.addEventListener('click', toggleChatBox);

        // Initial app load logic
        // Moved the core Firebase initialization logic into window.onload
        window.addEventListener('load', () => {
            applyTranslations(); // Apply initial translations

            // IMPORTANT: Firebase needs to be initialized ONCE, and `auth` and `db`
            // must be available globally or passed correctly.
            // The `try...catch` block for `initializeApp` handles the primary initialization.

            // Use onAuthStateChanged to react to auth state, including initial anonymous login from Canvas
            // This listener will ensure `auth.currentUser` is set once Firebase is ready.
            onAuthStateChanged(auth, (firebaseUser) => {
                if (firebaseUser) {
                    currentUser = { uid: firebaseUser.uid, displayName: 'anonymous', isAnonymous: true };
                    userIdDisplay.textContent = `${translations[currentLanguage].userId} ${currentUser.uid}`;
                    loginView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                    fetchSavedPrompts();
                } else {
                    loginView.classList.remove('hidden');
                    mainView.classList.add('hidden');
                }

                // If `initialAuthToken` is provided by the environment and no user is currently signed in,
                // try to sign in with the custom token.
                if (initialAuthToken && !auth.currentUser) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then(() => console.log("Signed in with custom token."))
                        .catch(error => console.error("Error signing in with custom token:", error));
                }
                // No automatic anonymous sign-in here. It will only happen via handleLogin if needed.
            });
        });

        // Initial setup for dark mode class
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.body.classList.add('dark');
        } else {
          document.body.classList.remove('dark');
        }

        // Listen for changes in color scheme
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
          if (event.matches) {
            document.body.classList.add('dark');
          } else {
            document.body.classList.remove('dark');
          }
        });
    </script>
</body>
</html>
